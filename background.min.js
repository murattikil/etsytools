function getUserData(a,b){chrome.storage.local.get(a,function(c){"undefined"==typeof c[a]&&(reset(a,function(c){b(c[a])}),exit),b(c[a])})}function setUserData(a,b,c){var d={};d[a]=b,chrome.storage.local.set(d,function(){"function"==typeof c&&c(b)})}function reset(a,b){data={hearted:0,unhearted:0,hour:genHour()},setUserData(a,data,function(a){"function"==typeof b&&b(a)})}function genHour(){var a=new Date;return parseInt(a.getUTCFullYear()+("0"+a.getUTCMonth().toString()).slice(-2)+("0"+a.getUTCDate().toString()).slice(-2)+("0"+a.getUTCHours().toString()).slice(-2))}var actions=[],tabs={};chrome.runtime.onInstalled.addListener(function(a){if("install"==a.reason)window.open("http://etsytools.reatlat.net/","_blank");else if("update"==a.reason){chrome.runtime.getManifest().version;window.open("http://etsytools.reatlat.net/","_blank")}}),chrome.tabs.onUpdated.addListener(function(a,b,c){c.url.indexOf("etsy.com")>=0?chrome.pageAction.show(a):chrome.pageAction.hide(a)}),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){return actions.unshift({h:1,tid:a.tabId}),!0},{urls:["*://www.etsy.com/add_favorite_shop.php","*://www.etsy.com/add_favorite_listing.php"]},[]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){return actions.unshift({h:-1,tid:a.tabId}),!0},{urls:["*://www.etsy.com/remove_favorite_shop.php","*://www.etsy.com/remove_favorite_listing.php"]},[]),chrome.webRequest.onCompleted.addListener(function(a){switch(a.method){case"POST":actions.unshift({h:1,tid:a.tabId});break;case"DELETE":actions.unshift({h:-1,tid:a.tabId})}return!0},{urls:["*://www.etsy.com/api/v2/ajax/collections/*/listings/*"]},[]),chrome.runtime.onMessage.addListener(function(a,b,c){if(a.userid){var d=a.userid;tabs[b.tab.id]=d,getUserData(d,function(a){var b=genHour();a.hour!=b?reset(d,function(b){setUserData(d,b,function(b){c(a)})}):c(a)})}return!0}),function a(){if(actions.length>0){for(var c,b={};void 0!=(c=actions.pop());)"undefined"==typeof b[c.tid]&&(b[c.tid]={hearted:0,unhearted:0}),c.h>0?b[c.tid].hearted+=c.h:b[c.tid].unhearted+=Math.abs(c.h);for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];if("undefined"==typeof tabs[d])console.log("Undefined tab");else{var f=tabs[d];getUserData(f,function(a){var b=genHour(),c=function(a,b){a.hearted+=b.hearted,a.unhearted+=b.unhearted,setUserData(f,a,function(a){chrome.tabs.sendMessage(parseInt(d),a,function(a){})})};a.hour!=b?reset(f,function(a){c(a,e)}):c(a,e)})}}}setTimeout(a,100)}();